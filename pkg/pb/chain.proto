syntax = "proto3";
package quorum.pb;
option go_package = "github.com/rumsystem/quorum/pkg/pb";

enum PackageType {
    TRX                   = 0;
    BLOCK                 = 1;
    BFT                   = 2;
    BLOCK_SYNC            = 3;
    BROADCAST             = 4;
}

message Package {
    PackageType type = 1;
    bytes       Data = 2;
}

enum ActionType {
    ADD    = 0;
    REMOVE = 1;
}

enum TrxStroageType {
    CHAIN = 0;
    CACHE = 1;
}

enum TrxType {
    POST         = 0; // post to group
    UPD_SYNCER   = 1; // owner update group syncer
    UPD_POSTER   = 2; // owner update group poster
    APP_CONFIG   = 3; // app configuration
    SERVICE_REQ  = 4;
    SERVICE_RESP = 5; 
    FORK         = 6; 
    ARCHIVE      = 7;
    reserved 8 to 100;
}

message Owner {
    string GroupId      = 1;
    string OwnerKeyname = 2;
    string OwnerPubkey  = 3;
    string Memo         = 4;
    reserved 5 to 100;
}

message PostItem {
    string TrxId        = 1;
    string SenderPubkey = 2;
    bytes  Content      = 3;
    int64  TimeStamp    = 4;
}

message UpdGroupPosterItem {
    Poster     Poster     = 1;
    ActionType Action     = 2;
    string     Memo       = 3;
    reserved   4 to 100;
}

message Poster {
    string     GroupId             = 1;
    string     PosterKeyname       = 2;
    string     PosterPubkey        = 3;
    string     Memo                = 4;
    reserved   5 to 100;
}

message Syncer {
   string     GroupId             = 1;
   string     SyncerKeyname       = 2;
   string     SyncerPubkey        = 3;
   string     Memo                = 4;
   reserved   5 to 100;
}

message UpdGroupSyncerItem {
    Syncer     Syncer     = 1;
    ActionType Action     = 2;
    string     Memo       = 3;
    reserved   4 to 100;
}

message Producer {
    string     GroupId             = 1;
    string     ProducerKeyanme     = 2;
    string     ProducerPubkey      = 3;
    string     Memo                = 4;
    reserved   5 to 100;
}

enum AppConfigType {
    INT    = 0;
    BOOL   = 1;
    STRING = 2;
    reserved 3 to 100;
}

message AppConfigItem{
    string        GroupId     = 1;
    ActionType    Action      = 2;
    AppConfigType Type        = 3;
    string        Name        = 4;
    string        Value       = 5;
    string        Memo        = 6;
}

message Trx {
    string         TrxId        = 1;
    TrxType        Type         = 2;    
    string         GroupId      = 3;
    bytes          Data         = 4; 
    int64          TimeStamp    = 5;
    string         Version      = 6;
    int64          ResendCount  = 7;
    int64          Nonce        = 8;
    string         SenderPubkey = 9;  
    bytes          Hash         = 10;
    bytes          SenderSign   = 11;
    TrxStroageType StorageType  = 12;
    reserved       13 to 100;
}

//BLOCK
message Block {    
    string        GroupId        = 1;
    uint64        BlockId        = 2;
    bytes         PrevHash       = 3;  
    string        ProducerPubkey = 4;
    repeated      Trx Trxs       = 5;
    int64         TimeStamp      = 6;
    Consensus     Consensus      = 7;    
    bytes         BlockHash      = 8;
    bytes         ProducerSign   = 9;  
}

//BFT_MSG
enum BftMsgType {
    HB_BFT = 0; //HBMsgV1
}

message BftMsg {
    BftMsgType Type = 1;
    bytes      Data = 2; 
}

//SYNC_MSG
enum SyncMsgType {
    REQ_BLOCK          = 0; // request block 
    REQ_BLOCK_RESP     = 1; // response request block
}

message SyncMsg {
    string      GroupId = 1;    
    SyncMsgType Type    = 2;
    bytes       Data    = 3;
}

message ReqBlock {
    string GroupId       = 1; //group id
    uint64 FromBlock     = 2; //from which block
    int32  BlksRequested = 3; //how many blocks requested, "-1" means many as possible
    string ReqPubkey     = 4; //requester pubkey
    bytes  Hash          = 5; 
    bytes  Sign          = 6;
}

message ReqBlockResp {
    string       GroupId         = 1;   
    string       RequesterPubkey = 2;
    string       ProviderPubkey  = 3;
    ReqBlkResult Result          = 4;        
    uint64       FromBlock       = 5;
    int32        BlksRequested   = 6;     
    int32        BlksProvided    = 7;
    BlocksBundle Blocks          = 8;
    bytes        Hash            = 9;
    bytes        Sign            = 10;
}

message BlocksBundle {
    repeated Block Blocks = 1;
}

enum ReqBlkResult {
    BLOCK_IN_RESP         = 0; //"block(s) in resp and I may have more"
    BLOCK_IN_RESP_ON_TOP  = 1; //"block(s) in resp and I have no more block(when get req)" 
    BLOCK_NOT_FOUND       = 2; //"no block in resp and I don't have the requested block"
}    

//BROADCAST_MSG
enum BroadcastType {
    GENERAL                = 0; // general broadcast
    reserved 1 to 100;
}

message BroadcastMsg {
    BroadcastType Type = 1;
    bytes         Data = 2;
}

enum GroupAuthType {
    PUBLIC   = 0;
    PRIVATE  = 1;
}

enum GroupConsenseType {
    POA = 0;
    POS = 1;
}

message Consensus {
    GroupConsenseType Type = 1;
    bytes             Data = 2;
}

message PoaConsensusInfo {
    string ConsensusId   = 1;    
    uint64 ChainVer      = 2; 
    string InTrx         = 3;
    ForkItem ForkInfo    = 4;
}

message GroupServices {
    PublishServiceItem PublishService = 1;
    SyncServiceItem    SyncService    = 2;
    ProduceServiceItem ProduceService = 3;
    CtnServiceItem     CtnService     = 4;
}

message GroupItem {
    string                 GroupId                 = 1;
    string                 GroupName               = 2;
    string                 OwnerPubKey             = 3;
    int64                  LastUpdate              = 4;
    Block                  GenesisBlock            = 5;
    GroupAuthType          AuthType                = 6;
    GroupConsenseType      ConsenseType            = 7;
    string                 CipherKey               = 8;
    string                 AppId                   = 9;    
    string                 AppName                 = 10;
    Owner                  MyOwner                 = 11;
    Poster                 MyPoster                = 12;
    Syncer                 MySyncer                = 13;
    Producer               MyProducer              = 14;
    GroupServices          GroupServices           = 15;
    reserved          16 to 100;
}

message GroupSeed {
    string        GroupId                   = 1;
    string        GroupName                 = 2;
    string        OwnerPubkey               = 3;
    GroupAuthType AuthType                  = 4;
    string        CipherKey                 = 5;
    string        AppId                     = 6;
    string        AppName                   = 7;
    Block         GenesisBlock              = 8;
    repeated      GroupService     Services = 9;
    bytes         Hash                      = 10;
    bytes         Signature                 = 11;
}

//GroupService
enum GroupTaskType {
    PUBLISH    = 0;
    SYNC       = 1;
    PRODUCE    = 2;
    CTN        = 3;
    reserved 4 to 100;
}

message GroupTask {
    GroupTaskType Type = 1;
    bytes         Data = 2;
}

message GroupService {
    GroupTaskType TaskType = 1;
    bytes         Data = 2;
}

message PublishServiceItem {
    string Term                   = 1;
    bytes  Contract               = 2;
    PublishServiceProofItem Proof = 3;
    reserved 4 to 100;
}

message SyncServiceItem {
    string Term                = 1;
    bytes  Contract            = 2;
    Syncer Syncer              = 3;
    SyncServiceProofItem Proof = 4;
    reserved 5 to 100;
}

message ProduceServiceItem {
    string   Term       = 1;    
    bytes    Contract   = 2;
    Producer Producer   = 3;    
    ProduceServiceProofItem Proof = 4;    
    reserved 5 to 100;
}

message CtnServiceItem {
    string          Term        = 1;
    bytes           Contract    = 2;
    repeated string APIs        = 3;
    reserved 4 to 100;
}

message PublishServiceProofItem {
    bytes Proof = 1;
    reserved 2 to 100;
}

message ProduceServiceProofItem {
    bytes Proof = 1;
    reserved 2 to 100;
}

message SyncServiceProofItem {
    bytes Proof = 1;
    reserved 2 to 100;
}

message CtnServiceProofItem {
    bytes Proof = 1;
    reserved 2 to 100;
}

message ReqGroupServiceProof {
    GroupTaskType    TaskType = 1;
    bytes            Data     = 2;
}

message  ReqGroupServiceItem {
    string                        ReqId           = 1;
    bytes                         Seed            = 2;
    uint64                        CurrentBlockId  = 3;
    repeated ReqGroupServiceProof Proofs = 4;
    string                        Memo            = 5;
    reserved  6 to 100;
}

message ServiceRespItem{
    string                RespId            = 1;
    string                GroupId           = 2;
    ReqGroupServiceItem   OrigReq           = 3;
    uint64                TimeStamp         = 4;
    string                CellarOwnerPubkey = 5;
}

message NodeSDKGroupItem {
    GroupItem Group          = 1;
    string    SignAlias      = 3;
    repeated  string ApiUrl  = 4;
    string    GroupSeed      = 5;
}

//HB_MSG
message HBTrxBundle {
    repeated Trx Trxs = 1;
}  

message HBMsgv1 {
    string           MsgId       = 1;
    string           ScopeId     = 2;    //for bft is consensusid, for change consensus is reqid
    uint64           Epoch       = 3;
    HBMsgPayloadType PayloadType = 4;   // RBC or BBA
    bytes            Payload     = 5; 
}

enum HBMsgPayloadType {
    RBC = 0;    
    BBA = 1;
}

// RBC
message RBCMsg {
    RBCMsgType Type    = 1;   //INIT_PROPOSE / PROOF / READY
    bytes      Payload = 2;
}

enum RBCMsgType {
    INIT_PROPOSE = 0;
    ECHO         = 1;
    READY        = 2;
}

message InitPropose {
    bytes          RootHash         = 1;
    repeated bytes Proof            = 2;
    int64          Index            = 3;
    int64          Leaves           = 4;
    int64          OriginalDataSize = 5;    
    string         RecvNodePubkey   = 6;    //producer which should handle this ecc data shard
    string         ProposerPubkey   = 7;    //producer which make this propose (part of ecc shards)
    bytes          ProposerSign     = 8;    //signature of producer made this propose
}

message Echo { 
    bytes          RootHash               = 1;
    repeated bytes Proof                  = 2;
    int64          Index                  = 3;
    int64          Leaves                 = 4;
    int64          OriginalDataSize       = 5;   
    string         OriginalProposerPubkey = 6;  //producer make this original input
    string         EchoProviderPubkey     = 7;  //producer which broadcast this Echo
    bytes          EchoProviderSign       = 8;  //signature of producer broadcast this Echo
}

message Ready {
    bytes  RootHash               = 1;
    string OriginalProposerPubkey = 2;
    string ReadyProviderPubkey    = 3;
    bytes  ReadyProviderSign      = 4;
}

// BBA
message BBAMsg {
    BBAMsgType Type       = 1; //BVAL or AUX
    bytes      Payload    = 2;
}

enum BBAMsgType {
    BVAL  = 0;
    AUX   = 1;
}

message Bval {
    string     ProposerId   = 1;
    string     SenderPubkey = 2;
    int64      Epoch        = 3;
    bool       Value        = 4;
}

message Aux {
    string     ProposerId   = 1;
    string     SenderPubkey = 2;
    uint64     Epoch        = 3;    
    bool       Value        = 4;
}

message ForkItem {
    string        GroupId          = 1;
    uint64        StartFromBlock   = 3;
    uint64        StartFromEpoch   = 4;
    uint64        EpochDuration    = 5;
    repeated      string Producers   = 6;
    string        Memo             = 7;
}

