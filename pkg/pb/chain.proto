syntax = "proto3";
package quorum.pb;
option go_package = "github.com/rumsystem/quorum/pkg/pb";

enum PackageType {
    TRX                   = 0;
    BLOCK                 = 1;
    BFT                   = 2;
    SYNC                  = 3;
    BROADCAST             = 4;
}

message Package {
    PackageType type = 1;
    bytes       Data = 2;
}

enum ActionType {
    ADD    = 0;
    REMOVE = 1;
}

enum TrxStroageType {
    CHAIN = 0;
    CACHE = 1;
}

enum TrxType {
    POST               = 0; // post to group
    UPD_GRP_SYNCER     = 1; // owner update group syncer
    CHAIN_CONFIG       = 2; // chain configuration
    APP_CONFIG         = 3; // app configuration
    FORK               = 4; 
    ARCHIVE            = 5;
    SERVICE_REQ        = 6;
    SERVICE_RESP       = 7; 
}

message PostItem {
    string TrxId        = 1;
    string SenderPubkey = 2;
    bytes  Content      = 3;
    int64  TimeStamp    = 4;
}

message ProducerItem {
   string     GroupId        = 1;
   string     ProducerPubkey = 2;
   string     ProofTrxId     = 3;
   int64      BlkCnt         = 4;   
   string     Memo           = 5;
}

message UpdGroupSyncerItem {
    Syncer     Syncer     = 1;
    ActionType Action     = 2;
    string     Memo       = 3;
}

message Syncer {
   string     GroupId             = 1;
   string     SyncerPubkey        = 2;
   string     Memo                = 3;
   reserved   4 to 100;
}

enum ChainConfigType {
    SET_TRX_AUTH_MODE = 0;
    UPD_DNY_LIST      = 1;
    UPD_ALW_LIST      = 2;
}

enum TrxAuthMode {
    FOLLOW_ALW_LIST = 0;
    FOLLOW_DNY_LIST = 1;
}

enum AuthListType {
    ALLOW_LIST = 0;
    DENY_LIST  = 1;
} 

message ChainConfigItem {
    string          GroupId        = 1;
    ChainConfigType Type           = 2;
    bytes           Data           = 3;
    string          OwnerPubkey    = 4;
    string          OwnerSignature = 5;
    int64           TimeStamp      = 6;       
    string          Memo           = 7; 
}

message ChainSendTrxRuleListItem {
    ActionType Action       = 1; 
    string     Pubkey       = 3;
    repeated   TrxType Type = 4;
}

message SetTrxAuthModeItem {
    TrxType     Type = 1;
    TrxAuthMode Mode = 2;
}

enum AppConfigType {
    INT    = 0;
    BOOL   = 1;
    STRING = 2;
}

message AppConfigItem{
    string        GroupId     = 1;
    ActionType    Action      = 2;
    string        Name        = 3;
    AppConfigType Type        = 4;
    string        Value       = 5;
    string        OwnerPubkey = 6;
    string        OwnerSign   = 7;
    string        Memo        = 8;
    int64         TimeStamp   = 9;
}

message Trx {
    string         TrxId        = 1;
    TrxType        Type         = 2;    
    string         GroupId      = 3;
    bytes          Data         = 4; 
    int64          TimeStamp    = 5;
    string         Version      = 6;
    int64          ResendCount  = 7;
    int64          Nonce        = 8;
    string         SenderPubkey = 9;  
    bytes          Hash         = 10;
    bytes          SenderSign   = 11;
    TrxStroageType StorageType  = 12;
    reserved       13 to 100;
}

//BLOCK
message Block {    
    string        GroupId        = 1;
    uint64        BlockId        = 2;
    bytes         PrevHash       = 3;  
    string        ProducerPubkey = 4;
    repeated      Trx Trxs       = 5;
    int64         TimeStamp      = 6;
    Consensus     Consensus      = 7;    
    bytes         BlockHash      = 8;
    bytes         ProducerSign   = 9;  
}

//BFT_MSG
enum BftMsgType {
    HB_BFT = 0; //HBMsgV1
}

message BftMsg {
    BftMsgType Type = 1;
    bytes      Data = 2; 
}

//SYNC_MSG
enum SyncMsgType {
    REQ_BLOCK          = 0; // request block 
    REQ_BLOCK_RESP     = 1; // response request block
}

message SyncMsg {
    string      GroupId = 1;    
    SyncMsgType Type    = 2;
    bytes       Data    = 3;
}

message ReqBlock {
    string GroupId       = 1; //group id
    uint64 FromBlock     = 2; //from which block
    int32  BlksRequested = 3; //how many blocks requested, "-1" means many as possible
    string ReqPubkey     = 4; //requester pubkey
    bytes  Hash          = 5; 
    bytes  Sign          = 6;
}

message ReqBlockResp {
    string       GroupId         = 1;   
    string       RequesterPubkey = 2;
    string       ProviderPubkey  = 3;
    ReqBlkResult Result          = 4;        
    uint64       FromBlock       = 5;
    int32        BlksRequested   = 6;     
    int32        BlksProvided    = 7;
    BlocksBundle Blocks          = 8;
    bytes        Hash            = 9;
    bytes        Sign            = 10;
}

message BlocksBundle {
    repeated Block Blocks = 1;
}

enum ReqBlkResult {
    BLOCK_IN_RESP         = 0; //"block(s) in resp and I may have more"
    BLOCK_IN_RESP_ON_TOP  = 1; //"block(s) in resp and I have no more block(when get req)" 
    BLOCK_NOT_FOUND       = 2; //"no block in resp and I don't have the requested block"
}    

//BROADCAST_MSG
enum BroadcastType {
    GENERAL                = 0; // general broadcast
}

message BroadcastMsg {
    BroadcastType Type = 1;
    bytes         Data = 2;
}

enum GroupSyncType {
    PUBLIC   = 0;
    PRIVATE  = 1;
}

enum GroupConsenseType {
    POA = 0;
    POS = 1;
}

message Consensus {
    GroupConsenseType Type = 1;
    bytes             Data = 2;
}

message PoaConsensusInfo {
    string ConsensusId   = 1;    
    uint64 ChainVer      = 2; 
    string InTrx         = 3;
    ForkItem ForkInfo   = 4;
}

message ForkItem {
    string        GroupId          = 1;
    uint64        StartFromBlock   = 3;
    uint64        StartFromEpoch   = 4;
    uint64        EpochDuration    = 5;
    repeated      string producers = 6;
    string        Memo             = 7;
}

message GroupItem {
    string            GroupId                 = 1;
    string            GroupName               = 2;
    string            OwnerPubKey             = 3;
    string            UserSignPubkey          = 4;
    int64             LastUpdate              = 5;
    Block             GenesisBlock            = 6;
    GroupSyncType     SyncType                = 7;
    GroupConsenseType ConsenseType            = 9;
    string            CipherKey               = 10;
    string            AppId                   = 11;    
    string            AppName                 = 12;
    reserved          13 to 100;
}

message GroupSeed {
    string        GroupId                   = 1;
    string        GroupName                 = 2;
    string        OwnerPubkey               = 3;
    GroupSyncType SyncType                  = 4;
    string        CipherKey                 = 5;
    string        AppId                     = 6;
    string        AppName                   = 7;
    Block         GenesisBlock              = 8;
    repeated      GroupServiceItem Services = 9;
    bytes         Hash                      = 10;
    bytes         Signature                 = 11;
}

//GroupService
enum GroupServiceType {
    BREW_SERVICE    = 0;
    SYNC_SERVICE    = 1;
    reserved 2 to 100;
}

message BrewServiceItem {
    string BrewerPubkey = 1;
    string SyncerPubkey = 2;
    string Term         = 3;    
    bytes  Contract     = 4;
    reserved 5 to 100;
}

message SyncServiceItem {
    string SyncerPubkey  = 1;
    string Term          = 2;
    bytes  Contract      = 3;
    reserved 4 to 100;
}

message GroupServiceItem {
    GroupServiceType   Type        = 1; 
    bytes              Service     = 2;
}

message BrewServiceProofItem {
    bytes Proof = 1;
    reserved 2 to 100;
}

message SyncServiceProofItem {
    bytes Proof = 1;
    reserved 2 to 100;
}

message ServiceReqProofItem {
    GroupServiceType   Type  = 1; //BREW or STORAGE
    bytes              Proof = 2; //StorageServiceProofItem or BrewServiceProofItem
}

message  AddToCellarReqItem {
    string              GroupId         = 1;
    GroupSeed           Seed            = 2;
    uint64              CurrentBlockId  = 3;
    ServiceReqProofItem Proof           = 4;
    string              Memo            = 5;
    bytes               Hash            = 6;
    bytes               Signature       = 7;
    reserved  8 to 100;
}

message AddToCellarRespItem{
    string GroupId                       = 1;
    AddToCellarReqItem OrigReq           = 2;
    uint64             TimeStamp         = 3;
    string             CellarOwnerPubkey = 4;
    bytes              Hash              = 5;
    bytes              Signature         = 6;
}

message CellarSyncDoneItem {
    string          GroupId      = 1;
    ReqBlockResp    ReqBlockResp = 2;
    string CellarOwnerPubkey     = 3;
    bytes Hash                   = 4;
    bytes Signature              = 5;
}

message NodeSDKGroupItem {
    GroupItem Group          = 1;
    string    SignAlias      = 3;
    repeated  string ApiUrl  = 4;
    string    GroupSeed      = 5;
}

//HB_MSG
message HBTrxBundle {
    repeated Trx Trxs = 1;
}  

message HBMsgv1 {
    string           MsgId       = 1;
    string           ScopeId     = 2;    //for bft is consensusid, for change consensus is reqid
    uint64           Epoch       = 3;
    HBMsgPayloadType PayloadType = 4;   // RBC or BBA
    bytes            Payload     = 5; 
}

enum HBMsgPayloadType {
    RBC = 0;    
    BBA = 1;
}

// RBC
message RBCMsg {
    RBCMsgType Type    = 1;   //INIT_PROPOSE / PROOF / READY
    bytes      Payload = 2;
}

enum RBCMsgType {
    INIT_PROPOSE = 0;
    ECHO         = 1;
    READY        = 2;
}

message InitPropose {
    bytes          RootHash         = 1;
    repeated bytes Proof            = 2;
    int64          Index            = 3;
    int64          Leaves           = 4;
    int64          OriginalDataSize = 5;    
    string         RecvNodePubkey   = 6;    //producer which should handle this ecc data shard
    string         ProposerPubkey   = 7;    //producer which make this propose (part of ecc shards)
    bytes          ProposerSign     = 8;    //signature of producer made this propose
}

message Echo { 
    bytes          RootHash               = 1;
    repeated bytes Proof                  = 2;
    int64          Index                  = 3;
    int64          Leaves                 = 4;
    int64          OriginalDataSize       = 5;   
    string         OriginalProposerPubkey = 6;  //producer make this original input
    string         EchoProviderPubkey     = 7;  //producer which broadcast this Echo
    bytes          EchoProviderSign       = 8;  //signature of producer broadcast this Echo
}

message Ready {
    bytes  RootHash               = 1;
    string OriginalProposerPubkey = 2;
    string ReadyProviderPubkey    = 3;
    bytes  ReadyProviderSign      = 4;
}

// BBA
message BBAMsg {
    BBAMsgType Type       = 1; //BVAL or AUX
    bytes      Payload    = 2;
}

enum BBAMsgType {
    BVAL  = 0;
    AUX   = 1;
}

message Bval {
    string     ProposerId   = 1;
    string     SenderPubkey = 2;
    int64      Epoch        = 3;
    bool       Value        = 4;
}

message Aux {
    string     ProposerId   = 1;
    string     SenderPubkey = 2;
    uint64     Epoch        = 3;    
    bool       Value        = 4;
}


